name: Build and push Docker Image

on:
    release:
        types: [published]
    repository_dispatch:
        types: [release-published]
    workflow_dispatch:

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: kraeuterakademie-it

jobs:
    build-and-push-nuxt:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v5
              with:
                  ref: ${{ github.event.client_payload.tag || github.ref }}
                  fetch-depth: 0

            - name: Set tag for metadata
              id: set-tag
              run: |
                  if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
                    TAG="${{ github.event.client_payload.tag }}"
                    if [ -z "$TAG" ]; then
                      TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                    fi
                  elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  else
                    TAG="${{ github.ref }}"
                  fi

                  # Ensure tag is in refs/tags/ format for metadata action
                  if [ -n "$TAG" ] && [[ ! "$TAG" == refs/* ]]; then
                    TAG="refs/tags/$TAG"
                  fi

                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "Using tag: $TAG"

                  # Set as environment variable for metadata action
                  echo "DOCKER_METADATA_REF=$TAG" >> $GITHUB_ENV

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Nuxt
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-nuxt
                  tags: |
                      type=raw,value=latest
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern={{major}}
                      type=ref,event=tag
                      type=sha,enable=${{ github.event_name != 'release' }}
              env:
                  DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
                  DOCKER_METADATA_PR_HEAD_SHA: true
                  GITHUB_REF: ${{ env.DOCKER_METADATA_REF || github.ref }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push Nuxt Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile.nuxt
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Trigger deployment
              uses: peter-evans/repository-dispatch@v4
              with:
                  token: ${{ secrets.DEPLOY_TOKEN }}
                  repository: FelixRizzolli/kraeuterakademie.it
                  event-type: nuxt-updated
                  client-payload: '{"ref": "${{ github.ref }}", "sha": "${{ github.sha }}"}'

    build-and-push-storybook:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v5
              with:
                  ref: ${{ github.event.client_payload.tag || github.ref }}
                  fetch-depth: 0

            - name: Set tag for metadata
              id: set-tag
              run: |
                  if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
                    TAG="${{ github.event.client_payload.tag }}"
                    if [ -z "$TAG" ]; then
                      TAG=$(git describe --tags --abbrev=0)
                    fi
                  fi

                  # Ensure tag is in refs/tags/ format for metadata action
                  if [ -n "$TAG" ] && [[ ! "$TAG" == refs/* ]]; then
                    TAG="refs/tags/$TAG"
                  fi

                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "Using tag: $TAG"

                  # Set as environment variable for metadata action
                  echo "DOCKER_METADATA_REF=$TAG" >> $GITHUB_ENV

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Extract metadata (tags, labels) for Storybook
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}-storybook
                  tags: |
                      type=raw,value=latest
                      type=semver,pattern={{version}}
                      type=semver,pattern={{major}}.{{minor}}
                      type=semver,pattern={{major}}
                      type=ref,event=tag
                      type=sha,enable=${{ github.event_name != 'release' }}
              env:
                  DOCKER_METADATA_ANNOTATIONS_LEVELS: manifest,index
                  DOCKER_METADATA_PR_HEAD_SHA: true
                  GITHUB_REF: ${{ env.DOCKER_METADATA_REF || github.ref }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push Storybook Docker image
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: ./Dockerfile.storybook
                  platforms: linux/amd64,linux/arm64
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
